<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mojo Labz â€“ Peptide Calculator</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root {
  /* Mojo Labz lab palette â€“ LIGHT */
  --bg: #f7f4ee;
  --card: #ffffff;
  --ink: #0b4453;
  --muted: #6e8694;
  --border: #d5dde2;
  --accent: #1499b5;
  --accent-2: #26b9c6;
  --accent-soft: #e3f4f7;
  --error: #e15b64;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html {
  -webkit-text-size-adjust: 100%;
}

body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:
    radial-gradient(1200px 800px at 10% -20%, #ffffff 0, #f7f4ee 45%, #f2f5f7 100%),
    var(--bg);
  color: var(--ink);
  transition: background 0.25s ease, color 0.25s ease;
}

/* DARK THEME OVERRIDES */
body.dark {
  --bg: #05090d;
  --card: #0f151a;
  --ink: #e5f2f6;
  --muted: #8ea1ad;
  --border: #27323a;
  --accent: #26b9c6;
  --accent-2: #6be0e5;
  --accent-soft: #041016;
  --error: #ff7b82;

  background:
    radial-gradient(1100px 700px at 100% -50%, #08151d 25%, #05090d 70%),
    var(--bg);
}

/* PAGE SHELL */
.page {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* HEADER */
.site-header {
  border-bottom: 1px solid rgba(0, 0, 0, 0.03);
}

.site-header__inner {
  max-width: 1080px;
  margin: 0 auto;
  padding: 14px 24px 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

.brand-lockup {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-logo {
  width: 52px;
  height: 52px;
  border-radius: 16px;
  overflow: hidden;
  background: var(--accent-soft);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.brand-text-main {
  font-weight: 800;
  font-size: 20px;
  letter-spacing: .09em;
  text-transform: uppercase;
}

.brand-text-sub {
  font-size: 13px;
  color: var(--muted);
}

/* Hero banner (transparent PNG) */
.hero-strip {
  width: 100%;
  border-top: 1px solid rgba(0,0,0,0.03);
  border-bottom: 1px solid rgba(0,0,0,0.03);
  background: radial-gradient(circle at 0% 0%, rgba(20,153,181,0.1), transparent 55%);
}

.hero-strip__inner {
  max-width: 1080px;
  margin: 0 auto;
  padding: 10px 24px 12px;
}

.hero-strip__image {
  width: 100%;
  max-height: 170px;
  object-fit: contain;
  display: block;
}

/* THEME TOGGLE */
.theme-toggle {
  font-size: 13px;
  padding: 7px 14px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.7);
  color: var(--muted);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: background .15s ease, border .15s ease, color .15s ease, transform .08s ease;
}

.theme-toggle:hover {
  border-color: var(--accent);
  color: var(--ink);
  background: var(--accent-soft);
  transform: translateY(-1px);
}

body.dark .theme-toggle {
  background: rgba(7,12,17,0.9);
}

/* MAIN CONTENT */
.content {
  flex: 1;
  padding: 18px 16px 32px;
}

.calc-shell {
  max-width: 1080px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
  gap: 18px;
  align-items: start;
}

@media (max-width: 860px) {
  .calc-shell {
    grid-template-columns: minmax(0,1fr);
  }
}

/* PANELS */
.panel {
  background: var(--card);
  border-radius: 18px;
  border: 1px solid var(--border);
  box-shadow:
    0 18px 45px rgba(7, 44, 60, 0.06),
    0 0 0 1px rgba(255,255,255,0.5);
  padding: 18px 18px 16px;
}

body.dark .panel {
  box-shadow:
    0 18px 40px rgba(0,0,0,0.65),
    0 0 0 1px rgba(255,255,255,0.03);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.panel-title {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -.02em;
}

.panel-caption {
  font-size: 12px;
  color: var(--muted);
}

/* FORM GRID */
.form-grid {
  display: grid;
  gap: 10px 12px;
  grid-template-columns: repeat(12, minmax(0,1fr));
}

.form-field {
  grid-column: span 6;
}

.form-field--short {
  grid-column: span 4;
}

.form-field--wide {
  grid-column: span 12;
}

@media (max-width: 860px) {
  .form-field,
  .form-field--short,
  .form-field--wide {
    grid-column: span 12;
  }
}

.field-label {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

/* INPUTS */
.input-control {
  width: 100%;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #fdfdfd;
  color: var(--ink);
  padding: 10px 13px;
  font-size: 15px;
  line-height: 1.35;
  min-height: 42px;
  outline: 2px solid transparent;
  outline-offset: 2px;
  transition: border .15s ease, box-shadow .15s ease, background .15s ease, outline .15s ease;
}

.input-control:focus {
  border-color: var(--accent);
  outline-color: rgba(20,153,181,0.25);
  box-shadow: 0 0 0 1px rgba(20,153,181,0.25);
}

body.dark .input-control {
  background: #0b1116;
  border-color: #25323a;
}

body.dark .input-control:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(38,185,198,0.35);
}

input[type="number"].input-control {
  appearance: textfield;
  -webkit-appearance: textfield;
  -moz-appearance: textfield;
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* DOSE INPUT GROUP */
.dose-row {
  display: grid;
  grid-template-columns: minmax(0,1fr) 110px;
  gap: 6px;
}

@media (max-width: 420px) {
  .dose-row {
    grid-template-columns: minmax(0,1fr) 96px;
  }
}

/* BUTTONS */
.button-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 4px;
}

.chip-button {
  border-radius: 999px;
  padding: 7px 13px;
  font-size: 13px;
  border: 1px solid var(--border);
  background: #f3f7f9;
  color: var(--ink);
  cursor: pointer;
  font-weight: 600;
  letter-spacing: .01em;
  transition: background .15s ease, border .15s ease, transform .08s ease, box-shadow .15s ease, color .15s ease;
}

.chip-button:hover {
  border-color: var(--accent);
  background: var(--accent-soft);
  transform: translateY(-1px);
  box-shadow: 0 0 0 1px rgba(20,153,181,0.2);
}

.chip-button--ghost {
  background: transparent;
  color: var(--muted);
}

.chip-button--ghost:hover {
  color: var(--ink);
}

.chip-button[aria-pressed="true"] {
  background: var(--accent-soft);
  border-color: var(--accent);
}

body.dark .chip-button {
  background: #0f171f;
  border-color: #27323a;
  color: var(--ink);
}

body.dark .chip-button:hover,
body.dark .chip-button[aria-pressed="true"] {
  background: #05141a;
}

/* PRESET DOSE SECTION */
.preset-label {
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
  margin-bottom: 2px;
}

/* RESULT PANEL */
.result-summary {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 14px;
}

.result-headline {
  font-size: 17px;
  font-weight: 700;
  letter-spacing: -.01em;
}

.result-line {
  font-size: 13px;
  color: var(--muted);
}

/* BADGE STRIP */
.badge-strip {
  display: grid;
  grid-template-columns: repeat(2,minmax(0,1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.badge-card {
  border-radius: 12px;
  border: 1px solid #cfd8dd;
  background: #ffffff;
  padding: 9px 11px;
  box-shadow: 0 8px 18px rgba(7,44,60,0.04);
}

body.dark .badge-card {
  background: #0f151a;
  border-color: #29353e;
  box-shadow: 0 12px 28px rgba(0,0,0,0.6);
}

.badge-label {
  font-size: 11px;
  color: var(--muted);
}

.badge-value {
  font-size: 18px;
  font-weight: 800;
  margin-top: 2px;
}

/* METER / SYRINGE VISUAL */
.meter-shell {
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--accent-soft);
  padding: 14px 14px 22px;
}

body.dark .meter-shell {
  background: radial-gradient(circle at 0 0,#102834 0,#051018 45%);
  border-color: #26333b;
}

.meter-label {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.meter-track {
  position: relative;
  height: 34px;
  border-radius: 18px;
  background: linear-gradient(180deg,#fdfefe,#e2e7ea);
  border: 1px solid #c8d2da;
  box-shadow:
    inset 0 2px 5px rgba(0,0,0,0.06),
    inset 0 1px 0 rgba(255,255,255,0.8);
}

body.dark .meter-track {
  background: linear-gradient(180deg,#151b22,#05070a);
  border-color: #27333b;
  box-shadow:
    inset 0 2px 9px rgba(0,0,0,0.9),
    inset 0 1px 0 rgba(255,255,255,0.04);
}

.meter-fill {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 0%;
  border-radius: 18px;
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  box-shadow:
    inset 0 0 10px rgba(255,255,255,0.35),
    0 0 14px rgba(20,153,181,0.45);
}

.meter-cursor {
  position: absolute;
  top: -7px;
  width: 2px;
  height: 48px;
  background: var(--accent-2);
  border-radius: 2px;
  box-shadow: 0 0 0 2px rgba(38,185,198,0.18);
}

.meter-ticks {
  margin-top: 9px;
  display: flex;
  justify-content: space-between;
  padding: 0 2px;
}

.meter-tick {
  width: 1px;
  background: #b7c4cd;
  position: relative;
}

.meter-tick--minor {
  height: 9px;
  opacity: .6;
}

.meter-tick--major {
  height: 15px;
}

.meter-tick-number {
  position: absolute;
  top: 17px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: var(--muted);
}

body.dark .meter-tick {
  background: #3a4b56;
}

/* WARNING / NOTE */
.calc-note {
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
}

.calc-warning {
  color: var(--error);
  font-weight: 600;
}

/* FOOTER LEGAL */
.fine-print {
  max-width: 1080px;
  margin: 18px auto 0;
  font-size: 11px;
  color: var(--muted);
  padding: 0 24px;
}

/* DEBUG HUD */
.hud {
  position: fixed;
  left: 12px;
  bottom: 12px;
  background: rgba(247,244,238,.98);
  color: var(--ink);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  font-size: 12px;
  line-height: 1.4;
  z-index: 9999;
  display: none;
  box-shadow: 0 10px 30px rgba(7,44,60,.12);
}

body.dark .hud {
  background: rgba(7,13,18,.96);
  border-color: #27333b;
  box-shadow: 0 10px 30px rgba(0,0,0,.75);
}

.hud.show {
  display: block;
}

.hud kbd {
  background: #e3edf3;
  border: 1px solid #c8d5de;
  border-radius: 6px;
  padding: 0 6px;
  margin: 0 2px;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  font-size: 11px;
  color: #234152;
}

body.dark .hud kbd {
  background: #101923;
  border-color: #324354;
  color: #e1edf5;
}
</style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header__inner">
      <div class="brand-lockup">
        <div class="brand-logo">
          <img src="Mojo-Labz.png" alt="Mojo Labz logo">
        </div>
        <div>
          <div class="brand-text-main">Mojo Labz</div>
          <div class="brand-text-sub">Peptide reconstitution helper</div>
        </div>
      </div>

      <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
        <span aria-hidden="true">ðŸŒ“</span>
        <span>Dark mode</span>
      </button>
    </div>

    <div class="hero-strip">
      <div class="hero-strip__inner">
        <img src="Mojo-Header.png" alt="Mojo Labz header" class="hero-strip__image">
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="content">
    <div class="calc-shell">

      <!-- LEFT: INPUT PANEL -->
      <section class="panel" aria-label="Peptide and syringe setup">
        <header class="panel-header">
          <div>
            <div class="panel-title">Vial & Dose Settings</div>
            <div class="panel-caption">Describe your peptide vial, diluent, and the dose you want to pull.</div>
          </div>
          <button id="clearAll" type="button" class="chip-button chip-button--ghost">
            Reset fields
          </button>
        </header>

        <div class="form-grid">
          <div class="form-field form-field--short">
            <div class="field-label">Peptide content per vial (mg)</div>
            <input id="vialMg" class="input-control" type="number" min="0" step="0.1" value="5">
          </div>

          <div class="form-field form-field--short">
            <div class="field-label">Total diluent added (mL)</div>
            <input id="diluentMl" class="input-control" type="number" min="0" step="0.1" value="1">
          </div>

          <div class="form-field form-field--short">
            <div class="field-label">Insulin syringe scale</div>
            <select id="syringeScale" class="input-control">
              <option value="30">30 units</option>
              <option value="50">50 units</option>
              <option value="100" selected>100 units</option>
            </select>
          </div>

          <div class="form-field form-field--wide">
            <div class="field-label">Desired dose</div>
            <div class="dose-row">
              <input id="doseAmount" class="input-control" type="number" min="0" step="0.001" value="0.5" inputmode="decimal">
              <select id="doseUnit" class="input-control">
                <option value="mcg">mcg</option>
                <option value="mg" selected>mg</option>
              </select>
            </div>
          </div>
        </div>

        <div class="preset-label">Quick dose buttons</div>
        <div id="presetsMg" class="button-row" role="group" aria-label="Preset doses in milligrams">
          <button class="chip-button preset-dose" data-dose="1" data-unit="mg">1 mg</button>
          <button class="chip-button preset-dose" data-dose="2" data-unit="mg">2 mg</button>
          <button class="chip-button preset-dose" data-dose="5" data-unit="mg">5 mg</button>
          <button class="chip-button preset-dose" data-dose="10" data-unit="mg">10 mg</button>
        </div>

        <div id="presetsMcg" class="button-row" role="group" aria-label="Preset doses in micrograms" style="display:none">
          <button class="chip-button preset-dose" data-dose="50" data-unit="mcg">50 mcg</button>
          <button class="chip-button preset-dose" data-dose="100" data-unit="mcg">100 mcg</button>
          <button class="chip-button preset-dose" data-dose="250" data-unit="mcg">250 mcg</button>
          <button class="chip-button preset-dose" data-dose="500" data-unit="mcg">500 mcg</button>
        </div>

        <p class="calc-note" style="margin-top:10px;">
          Assumes a U-100 insulin syringe, where <strong>1 unit = 0.01 mL</strong>. Values update as you type.
        </p>
      </section>

      <!-- RIGHT: RESULT PANEL -->
      <section class="panel" aria-label="Dose result and visual guide">
        <header class="panel-header">
          <div>
            <div class="panel-title">Pull this amount</div>
            <div class="panel-caption">How many units to draw for the dose youâ€™ve specified.</div>
          </div>
        </header>

        <div class="result-summary">
          <div class="result-headline">
            For a dose of
            <span id="doseSummaryValue">0.5</span>
            <span id="doseSummaryUnit">mg</span>,
            draw to
            <span id="unitsDisplay">â€”</span>
            <span id="unitsLabel">units</span>
            on your syringe.
          </div>
          <div class="result-line">
            The graphic below is a visual helper only and is not a medical device.
          </div>
        </div>

        <div class="badge-strip">
          <div class="badge-card">
            <div class="badge-label">Units to pull</div>
            <div class="badge-value" id="unitsDisplayChip">â€”</div>
            <div class="badge-label"><span id="mlDisplay">â€”</span></div>
          </div>
          <div class="badge-card">
            <div class="badge-label">Concentration</div>
            <div class="badge-value" id="potencyDisplay">â€”</div>
            <div class="badge-label">
              <span id="potencyUnitDisplay">mg</span> per unit
            </div>
          </div>
        </div>

        <div class="meter-shell" aria-live="polite">
          <div class="meter-label">Syringe units (0 to selected max)</div>
          <div class="meter-track">
            <div class="meter-fill" id="meterFill"></div>
            <div class="meter-cursor" id="meterCursor" aria-hidden="true"></div>
          </div>
          <div class="meter-ticks" id="meterTicks" aria-hidden="true"></div>
        </div>

        <p id="warningText" class="calc-note" style="margin-top:8px;"></p>
      </section>

    </div>

    <section class="fine-print">
      This calculator is intended for informational and educational purposes only and should not be used as a substitute
      for professional medical advice, diagnosis, or treatment. Always confirm calculations and protocols with a qualified
      healthcare provider before administering any medication or peptide.
    </section>
  </main>
</div>

<!-- DEBUG HUD (press D) -->
<div id="hud" class="hud" aria-live="polite">
  <strong>Debug:</strong> Press <kbd>D</kbd> to hide<br>
  <span id="hudVals"></span>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);

  /* THEME TOGGLING */
  const bodyEl = document.body;
  const themeToggle = $('themeToggle');

  function applyStoredTheme() {
    try {
      const saved = localStorage.getItem('mojo-theme');
      const prefersDark = window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (saved === 'dark' || (!saved && prefersDark)) {
        bodyEl.classList.add('dark');
      }
    } catch (e) {
      // ignore storage issues
    }
  }

  function updateThemeToggleLabel() {
    const dark = bodyEl.classList.contains('dark');
    if (!themeToggle) return;
    themeToggle.setAttribute('aria-pressed', dark ? 'true' : 'false');
    themeToggle.querySelector('span:last-child').textContent = dark ? 'Light mode' : 'Dark mode';
  }

  applyStoredTheme();
  updateThemeToggleLabel();

  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      bodyEl.classList.toggle('dark');
      const darkNow = bodyEl.classList.contains('dark');
      try {
        localStorage.setItem('mojo-theme', darkNow ? 'dark' : 'light');
      } catch (e) {}
      updateThemeToggleLabel();
    });
  }

  /* CALCULATOR LOGIC */

  const inputs = {
    vialMg: $('vialMg'),
    diluentMl: $('diluentMl'),
    scale: $('syringeScale'),
    doseAmount: $('doseAmount'),
    doseUnit: $('doseUnit')
  };

  const outputs = {
    doseSummaryValue: $('doseSummaryValue'),
    doseSummaryUnit: $('doseSummaryUnit'),
    unitsDisplay: $('unitsDisplay'),
    unitsLabel: $('unitsLabel'),
    mlDisplay: $('mlDisplay'),
    potencyDisplay: $('potencyDisplay'),
    potencyUnitDisplay: $('potencyUnitDisplay'),
    unitsDisplayChip: $('unitsDisplayChip'),
    warningText: $('warningText'),
    meterFill: $('meterFill'),
    meterCursor: $('meterCursor'),
    meterTicks: $('meterTicks')
  };

  const presetGroups = {
    mg: $('presetsMg'),
    mcg: $('presetsMcg')
  };

  const hud = $('hud');
  const hudVals = $('hudVals');
  let debug = false;

  const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
  const formatNumber = (value, decimals = 2) => {
    if (!Number.isFinite(value)) return 'â€”';
    const fixed = value.toFixed(decimals);
    return fixed.replace(/\.0+$/, '').replace(/(\.[1-9]*)0+$/, '$1');
  };

  function parseInput(el) {
    const n = parseFloat(el.value);
    return Number.isFinite(n) ? n : NaN;
  }

  function buildTicks() {
    outputs.meterTicks.innerHTML = '';
    const maxUnits = parseInt(inputs.scale.value, 10) || 30;
    const minorStep = maxUnits <= 30 ? 1 : 5;
    const majorStep = maxUnits <= 30 ? 5 : 10;

    for (let i = 0; i <= maxUnits; i += minorStep) {
      const node = document.createElement('div');
      node.className = 'meter-tick ' + (i % majorStep === 0 ? 'meter-tick--major' : 'meter-tick--minor');
      if (i % majorStep === 0) {
        const n = document.createElement('div');
        n.className = 'meter-tick-number';
        n.textContent = i;
        node.appendChild(n);
      }
      outputs.meterTicks.appendChild(node);
    }
  }

  function currentDoseInMcg() {
    const val = parseInput(inputs.doseAmount);
    if (!Number.isFinite(val) || val <= 0) return NaN;
    return inputs.doseUnit.value === 'mg' ? val * 1000 : val;
  }

  function recalc() {
    const mgPerVial = parseInput(inputs.vialMg);
    const diluentMl = parseInput(inputs.diluentMl);
    const maxUnits = parseInt(inputs.scale.value, 10) || 30;

    const concentrationMgPerMl = (mgPerVial > 0 && diluentMl > 0) ? (mgPerVial / diluentMl) : NaN;
    const mcgPerUnit = Number.isFinite(concentrationMgPerMl) ? concentrationMgPerMl * 10 : NaN;
    const mgPerUnit = Number.isFinite(mcgPerUnit) ? mcgPerUnit / 1000 : NaN;

    const desiredMcg = currentDoseInMcg();
    const unitsNeeded = (Number.isFinite(mcgPerUnit) && Number.isFinite(desiredMcg))
      ? desiredMcg / mcgPerUnit
      : NaN;
    const mlToPull = Number.isFinite(unitsNeeded) ? unitsNeeded * 0.01 : NaN;

    // Summaries and units
    if (inputs.doseUnit.value === 'mg') {
      const mgVal = desiredMcg / 1000;
      outputs.doseSummaryValue.textContent = formatNumber(mgVal, 3);
      outputs.doseSummaryUnit.textContent = 'mg';
      outputs.potencyDisplay.textContent = Number.isFinite(mgPerUnit)
        ? formatNumber(mgPerUnit, 4)
        : 'â€”';
      outputs.potencyUnitDisplay.textContent = 'mg';
    } else {
      outputs.doseSummaryValue.textContent = formatNumber(desiredMcg, 0);
      outputs.doseSummaryUnit.textContent = 'mcg';
      outputs.potencyDisplay.textContent = Number.isFinite(mcgPerUnit)
        ? formatNumber(mcgPerUnit, 2)
        : 'â€”';
      outputs.potencyUnitDisplay.textContent = 'mcg';
    }

    outputs.unitsDisplay.textContent = formatNumber(unitsNeeded, 2);
    outputs.unitsDisplayChip.textContent = Number.isFinite(unitsNeeded)
      ? formatNumber(unitsNeeded, 2)
      : 'â€”';

    outputs.unitsLabel.textContent = (Math.abs((unitsNeeded || 0) - 1) < 0.005) ? 'unit' : 'units';
    outputs.mlDisplay.textContent = Number.isFinite(mlToPull)
      ? formatNumber(mlToPull, 3) + ' mL'
      : 'â€”';

    const pct = Number.isFinite(unitsNeeded)
      ? clamp(unitsNeeded / maxUnits * 100, 0, 100)
      : 0;
    outputs.meterFill.style.width = pct + '%';
    outputs.meterCursor.style.left = `calc(${pct}% - 1px)`;

    outputs.warningText.textContent = '';
    outputs.warningText.classList.remove('calc-warning');

    if (!Number.isFinite(unitsNeeded)) {
      outputs.warningText.textContent = 'Enter positive values for vial content, diluent amount, and dose.';
      outputs.warningText.classList.add('calc-warning');
    } else if (unitsNeeded > maxUnits) {
      outputs.warningText.textContent = `âš  The requested dose exceeds the selected syringe scale of ${maxUnits} units.`;
      outputs.warningText.classList.add('calc-warning');
    }

    if (debug && hudVals) {
      hudVals.textContent =
        `mcg desired: ${formatNumber(desiredMcg, 2)} | ` +
        `units: ${formatNumber(unitsNeeded, 3)} | ` +
        `mcg/unit: ${formatNumber(mcgPerUnit, 3)}`;
    }
  }

  function clearAll() {
    inputs.vialMg.value = '';
    inputs.diluentMl.value = '';
    inputs.doseAmount.value = '';
    inputs.doseUnit.value = 'mg';
    inputs.scale.value = '100';

    const allPresets = document.querySelectorAll('.preset-dose');
    allPresets.forEach(btn => btn.setAttribute('aria-pressed', 'false'));

    updatePresetVisibility();
    buildTicks();
    recalc();
  }

  function wirePresets(container) {
    container.querySelectorAll('.preset-dose').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.preset-dose').forEach(
          b => b.setAttribute('aria-pressed', 'false')
        );
        btn.setAttribute('aria-pressed', 'true');
        const dose = btn.dataset.dose;
        const unit = btn.dataset.unit;
        inputs.doseUnit.value = unit;
        inputs.doseAmount.value = dose;
        updatePresetVisibility();
        recalc();
      });
    });
  }

  function updatePresetVisibility() {
    const useMg = inputs.doseUnit.value === 'mg';
    presetGroups.mg.style.display = useMg ? 'flex' : 'none';
    presetGroups.mcg.style.display = useMg ? 'none' : 'flex';
  }

  function convertDoseValue(previousUnit, nextUnit) {
    const val = parseInput(inputs.doseAmount);
    if (!Number.isFinite(val) || previousUnit === nextUnit) return;
    if (previousUnit === 'mcg' && nextUnit === 'mg') {
      inputs.doseAmount.value = val / 1000;
    } else if (previousUnit === 'mg' && nextUnit === 'mcg') {
      inputs.doseAmount.value = val * 1000;
    }
  }

  // Wire events
  ['input','change'].forEach(evt => {
    [inputs.vialMg, inputs.diluentMl, inputs.scale, inputs.doseAmount].forEach(el => {
      el.addEventListener(evt, () => {
        if (el === inputs.scale) buildTicks();
        recalc();
      });
    });
  });

  let lastDoseUnit = inputs.doseUnit.value;
  inputs.doseUnit.addEventListener('change', () => {
    convertDoseValue(lastDoseUnit, inputs.doseUnit.value);
    lastDoseUnit = inputs.doseUnit.value;
    updatePresetVisibility();
    document.querySelectorAll('.preset-dose').forEach(
      b => b.setAttribute('aria-pressed', 'false')
    );
    recalc();
  });

  const clearBtn = $('clearAll');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearAll);
  }

  wirePresets(presetGroups.mg);
  wirePresets(presetGroups.mcg);
  buildTicks();
  updatePresetVisibility();
  recalc();

  // DEBUG HUD toggle
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'd') {
      debug = !debug;
      hud.classList.toggle('show', debug);
      if (debug && hudVals) {
        const maxUnits = parseInt(inputs.scale.value, 10) || 30;
        hudVals.textContent = `Syringe scale: ${maxUnits} units`;
      }
    }
  });
});
</script>
</body>
</html>
